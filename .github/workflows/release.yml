name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build, Sign and Release
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Import Signing Certificate
        uses: apple-actions/import-codesign-certs@v2
        with: 
          p12-file-base64: ${{ secrets.MACOS_CERTIFICATE }}
          p12-password: ${{ secrets.MACOS_CERTIFICATE_PWD }}

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Set App Version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          sed -i '' "s/static let appVersion = \".*\"/static let appVersion = \"$VERSION\"/" Sources/App/AppConfig.swift
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build Application
        run: ./scripts/bundle.sh
        env:
          VERSION: ${{ env.VERSION }}
          SPARKLE_PUBLIC_KEY: ${{ secrets.MACOS_SPARKLE_PUBLIC_KEY }}

      - name: Sign Application
        run: ./scripts/sign.sh

      - name: Create DMG
        run: ./scripts/package.sh
        
      - name: Generate Sparkle Appcast
        run: ./scripts/generate_appcast.sh
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.MACOS_SPARKLE_PRIVATE_KEY }}
          TAG_NAME: ${{ github.ref_name }}

      - name: Commit Appcast to Repo
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          mv release_assets/appcast.xml .
          git add appcast.xml
          
          # Pull latest main to avoid conflicts
          git fetch origin main
          git checkout main
          git pull origin main
          git add appcast.xml
          git commit -m "chore: Update appcast.xml for ${{ github.ref_name }}" || echo "No changes to appcast"
          git push origin main

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: |
            ValetBar.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
